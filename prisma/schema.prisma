// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Users & Auth ---

model User {
  id           String    @id @default(uuid())
  username     String    @unique
  email        String    @unique
  password     String // Hashed
  role         String    @default("user") // admin, manager, agent, user
  permissions  String[]
  status       String    @default("active")
  lastLogin    DateTime?
  lastLogout   DateTime?
  lastActivity DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  visits                Visit[]
  projects              ConstructionProject[]
  tickets               Ticket[]
  auditLogs             AuditLog[]
  assets                Asset[]
  documents             Document[]
  transactionsRecorded  Transaction[]         @relation("TransactionRecorder")
  transactionsValidated Transaction[]         @relation("TransactionValidator")
  expenses              ExpenseReport[]
  legalCases            LegalCase[]

  employee Employee?

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  organizedMeetings     Meeting[]      @relation("OrganizedMeetings")
  participatingMeetings Meeting[]      @relation("MeetingParticipants")
  notifications         Notification[]
}

// --- Agencies ---

model Agency {
  id        String   @id @default(uuid())
  name      String
  address   String
  city      String
  phone     String
  email     String
  manager   String
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employees     Employee[]
  PayrollRun    PayrollRun[]
  Transaction   Transaction[]
  Invoice       Invoice[]
  ExpenseReport ExpenseReport[]
  Property      Property[]
}

// --- HR ---

model Employee {
  id              String   @id @default(uuid())
  matricule       String?  @unique
  firstName       String
  lastName        String
  position        String
  department      String
  email           String   @unique
  phone           String
  startDate       DateTime
  salary          Float
  status          String   @default("active") // active, on_leave, terminated
  rejectionReason String?

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  pendingAgencyId        String? // For validation workflow
  assignmentNotification Boolean @default(false)

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payrollItems PayrollItem[]

  // Identity & Social
  identityType     String? // CNI, PASSPORT
  identityNumber   String?
  identityDocument String? // Path to file
  photo            String? // Path to file
  cmuNumber        String?
  cnpsNumber       String?
}

model PayrollRun {
  id              String   @id @default(uuid())
  month           Int
  year            Int
  status          String   @default("draft") // draft, hr_validated, finance_validated, direction_approved, paid
  totalAmount     Float    @default(0)
  notes           String?
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items PayrollItem[]

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  @@unique([month, year, agencyId]) // Scoped uniqueness by agency
}

model PayrollItem {
  id         String @id @default(uuid())
  baseSalary Float
  bonus      Float  @default(0) // Other bonuses

  // Deductions & Taxes
  its               Float @default(0) // Impôt sur Traitements et Salaires
  cnps              Float @default(0) // Caisse Nationale de Prévoyance Sociale
  salaryAdvance     Float @default(0) // Avance sur salaire
  latenessDeduction Float @default(0) // Retenue pour retard

  deduction Float @default(0) // Other deductions
  netSalary Float

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id])
}

// --- Commercial ---

model Client {
  id          String   @id @default(uuid())
  firstName   String
  lastName    String
  email       String?  @unique // Optional now
  phone       String
  idType      String? // CNI, Passport, Attestation
  idNumber    String? // The ID number
  photo       String? // URL/Path to profile photo
  idCardRecto String? // URL/Path to ID card recto
  idCardVerso String? // URL/Path to ID card verso
  type        String // buyer, seller, tenant, landloard
  status      String // active, inactive, prospect
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  visits     Visit[]
  contracts  Contract[]
  invoices   Invoice[]
  legalCases LegalCase[]

  // Real Estate Relations
  ownedLots          DevelopmentLot[] // Lots bought by this client
  subscriptions      Subscription[] // Pre-financing subscriptions
  occupiedProperties Property[]       @relation("PropertyOccupant") // Tenant of built properties
}

// --- Properties ---

model Property {
  id          String   @id @default(uuid())
  reference   String? // e.g. "VILLA-001"
  title       String
  description String?
  price       Float
  type        String // apartment, villa, land, commercial
  status      String // available, sold, rented, maintenance
  address     String
  city        String
  area        Float
  rooms       Int
  images      String[]
  features    String[]

  // Financials for Built Properties
  rentalValue Float? // Montant du loyer si location
  usage       String? // habitation, commercial, mixe

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  developmentId String?
  development   LandDevelopment? @relation(fields: [developmentId], references: [id])
  visits        Visit[]
  contracts     Contract[]
  legalCases    LegalCase[]

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  occupantId String?
  occupant   Client? @relation("PropertyOccupant", fields: [occupantId], references: [id])
}

// --- Land Development (Projets de Lotissement) ---

model LandDevelopment {
  id       String @id @default(uuid())
  name     String
  location String

  // Legal & Land Details
  legalTitle  String? // ACD, Attestation Villageoise, CFC
  titleNumber String? // Numéro du titre
  landOwner   String? // Nom du détenteur du titre (si différent de l'agence)
  boundaries  String? // Limites / Bornage description
  legalStatus String? // Libre, En litige, Hypothéqué
  planUrl     String? // URL/Path to the development plan image

  // Project Scope
  totalArea Float
  totalLots Int

  // Financials
  acquisitionCost   Float @default(0) // Coût du terrain
  developmentBudget Float @default(0) // Coût aménagement (VRD, etc)
  lotUnitCost       Float @default(0) // Coût de revient par lot
  expectedMargin    Float @default(0) // Marge prévisionnelle

  rejectionReason   String? // Motif de rejet si applicable
  status    String // pending, planned, in_progress, completed, paused, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  properties    Property[] // Linked built properties (if any)
  lots          DevelopmentLot[]
  phases        ProjectPhase[]
  subscriptions Subscription[]
}

model DevelopmentLot {
  id        String @id @default(uuid())
  lotNumber   String // Just the number e.g. "12"
  blockNumber String? // "Ilot 4"
  area      Float // m²
  type      String // habitation, commercial, mixe
  status    String // available, reserved, sold, pre_financed
  ownerType String @default("ELITE") // ELITE, FAMILY, PARTNER
  price     Float // Prix de vente public

  features String[] // Specificites du lot (angle, voie bitumée...)

  developmentId String
  development   LandDevelopment @relation(fields: [developmentId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  subscription Subscription? // If pre-financed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProjectPhase {
  id        String    @id @default(uuid())
  name      String // Acquisition, Bornage, Lotissement, Aménagement, Commercialisation...
  startDate DateTime
  endDate   DateTime?
  status    String // pending, in_progress, completed, delayed
  progress  Int       @default(0) // %
  notes     String?

  developmentId String
  development   LandDevelopment @relation(fields: [developmentId], references: [id])
}

model Subscription {
  id              String @id @default(uuid())
  // Pre-financing Contract
  depositAmount   Float
  totalAmount     Float
  paymentSchedule Json? // Stores schedule details
  status          String // active, completed, defaulted, cancelled
  penalties       Float  @default(0)

  contractDate DateTime @default(now())

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  developmentId String
  development   LandDevelopment @relation(fields: [developmentId], references: [id])

  lotId String?         @unique
  lot   DevelopmentLot? @relation(fields: [lotId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Visits ---

model Visit {
  id     String   @id @default(uuid())
  date   DateTime
  status String // scheduled, completed, cancelled
  notes  String?

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  agentId String
  agent   User   @relation(fields: [agentId], references: [id])
}

// --- Construction ---

model ConstructionProject {
  id              String    @id @default(uuid())
  name            String
  location        String
  type            String
  status          String // planned, in_progress, completed, paused
  rejectionReason String?
  budget          Float
  spent           Float     @default(0)
  progress        Int       @default(0)
  startDate       DateTime
  endDate         DateTime?

  managerId String
  manager   User   @relation(fields: [managerId], references: [id])

  milestones    Milestone[]
  ExpenseReport ExpenseReport[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Milestone {
  id        String   @id @default(uuid())
  title     String
  date      DateTime
  completed Boolean  @default(false)

  projectId String
  project   ConstructionProject @relation(fields: [projectId], references: [id])
}

// --- Finance ---

model Transaction {
  id              String   @id @default(uuid())
  date            DateTime
  description     String
  amount          Float
  type            String // income, expense
  category        String
  status          String // pending, completed, cancelled
  rejectionReason String?
  reference       String?
  paymentMethod   String

  recordedBy  String?
  recorder    User?   @relation("TransactionRecorder", fields: [recordedBy], references: [id])
  validatedBy String?
  validator   User?   @relation("TransactionValidator", fields: [validatedBy], references: [id])
  sourceId    String?
  sourceType  String? // invoice, expense, payroll

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])
}

model Invoice {
  id              String   @id @default(uuid())
  number          String   @unique
  type            String // invoice, quote
  status          String // draft, sent, paid, overdue, agency_validated
  rejectionReason String?
  issueDate       DateTime
  dueDate         DateTime
  subtotal        Float
  taxAmount       Float
  total           Float

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  items InvoiceItem[]
}

model InvoiceItem {
  id          String @id @default(uuid())
  description String
  quantity    Int
  unitPrice   Float
  total       Float

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])
}

model ExpenseReport {
  id              String   @id @default(uuid())
  amount          Float
  category        String
  status          String // pending, agency_validated, approved, rejected
  rejectionReason String?
  date            DateTime
  description     String
  receiptUrl      String?

  submitterId String
  submitter   User                 @relation(fields: [submitterId], references: [id])
  projectId   String?
  project     ConstructionProject? @relation(fields: [projectId], references: [id])

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])
}

// --- Legal ---

model Contract {
  id          String    @id @default(uuid())
  title       String
  type        String
  startDate   DateTime
  endDate     DateTime?
  status      String
  documentUrl String?
  reference   String?

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])
}

model LegalCase {
  id          String   @id @default(uuid())
  title       String
  description String
  status      String   @default("open")
  priority    String   @default("medium")
  type        String   @default("other")
  openedDate  DateTime @default(now())
  reference   String?

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])
}

// --- Documents ---

model Document {
  id        String   @id @default(uuid())
  name      String
  type      String
  size      String
  path      String
  category  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])
}

// --- IT ---

model Asset {
  id           String   @id @default(uuid())
  name         String
  type         String
  serialNumber String   @unique
  status       String
  purchaseDate DateTime

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])
}

model Ticket {
  id          String   @id @default(uuid())
  title       String
  description String
  priority    String
  status      String
  category    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  requesterId String
  requester   User   @relation(fields: [requesterId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  details   String
  module    String?
  timestamp DateTime @default(now())
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

// --- Messaging ---

model Message {
  id      String  @id @default(uuid())
  content String
  read    Boolean @default(false)

  senderId String
  sender   User   @relation("SentMessages", fields: [senderId], references: [id])

  receiverId String
  receiver   User   @relation("ReceivedMessages", fields: [receiverId], references: [id])

  attachmentUrl String?

  createdAt DateTime @default(now())
}

model Meeting {
  id          String   @id @default(uuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  link        String? // Jitsi Meet URL
  status      String   @default("scheduled") // scheduled, cancelled, completed

  organizerId String
  organizer   User   @relation("OrganizedMeetings", fields: [organizerId], references: [id])

  // Implicit many-to-many for participants
  participants User[] @relation("MeetingParticipants")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   @default("info") // info, success, warning, error
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])
}
